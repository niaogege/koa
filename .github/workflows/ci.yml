name: CI

# åœ¨mainåˆ†æ”¯å‘ç”Ÿpushäº‹ä»¶/pull_requestæ—¶è§¦å‘ã€‚
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  # è®¾ç½®çŽ¯å¢ƒå˜é‡
  TARGET_DIR: /www/web/koa

jobs:
  # æ‰“åŒ…æž„å»º
  depoly:
    runs-on: ubuntu-latest # è¿è¡Œåœ¨è™šæ‹ŸæœºçŽ¯å¢ƒubuntu-latest
    steps:
      - name: Checkout # æ­¥éª¤1
        uses: actions/checkout@v1 # ä½¿ç”¨çš„åŠ¨ä½œã€‚æ ¼å¼ï¼šuserName/repoNameã€‚ä½œç”¨ï¼šæ£€å‡ºä»“åº“ï¼ŒèŽ·å–æºç ã€‚ å®˜æ–¹actionsåº“ï¼šhttps://github.com/actions
      # - name: Use Node.js # æ­¥éª¤2
      #   uses: actions/setup-node@v1 # ä½œç”¨ï¼šå®‰è£…nodejs
      #   with:
      #     node-version: ${{ matrix.node-version }} # ç‰ˆæœ¬
      # - name: run deploy # æ­¥éª¤3
      #   env: # è®¾ç½®çŽ¯å¢ƒå˜é‡
      #     GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }} # toKenç§å¯†å˜é‡
      #   run: npm i && npm run deploy

      # 3. å°†æ‰“åŒ…åŽçš„ä»£ç éƒ¨ç½²åˆ° gh-pages åˆ†æ”¯
      # - name: Deploy ðŸš€
      #   uses: JamesIves/github-pages-deploy-action@3.5.7
      #   with:
      #     # ä¸ºäº†è®© GitHubè§¦å‘é‡æ–°æž„å»ºé¡µé¢ï¼Œæ‚¨å¿…é¡»ä½¿ç”¨å­˜å‚¨åº“æä¾›çš„GitHubä»¤ç‰Œæ¥æä¾›æ“ä½œ, GITHUB_TOKEN æ˜¯ç³»ç»Ÿé»˜è®¤æä¾›çš„  ä¸éœ€è¦å•ç‹¬é…ç½®çŽ¯å¢ƒå˜é‡
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     BRANCH: gh-pages
      #     FOLDER: dist
      - name: Deploy Server
        uses: cross-the-world/ssh-scp-ssh-pipelines@latest
        env:
          WELCOME: "ssh scp ssh pipelines CPP server"
          LASTSSH: "after copying"
        with:
          host: "111.230.199.157"
          user: "root"
          pass: ${{ secrets.FTP_PASSWORD }}
          connect_timeout: 20s
          first_ssh: |-
            rm -rf $TARGET_DIR
            echo $WELCOME   
            mkdir -p $TARGET_DIR
          scp: |-
            './*' => $TARGET_DIR/
          last_ssh: |-
            cd $TARGET_DIR
            node -v
            npm i
            pm2 -v
            pm2 start ./index.js -i max
            echo $LASTSSH
